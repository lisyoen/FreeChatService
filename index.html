<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" >
	<meta name="viewport" content="width=device-width, initial-scale=1" >
	<title>lisyoen's www root</title>
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.css" />
	<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.js"></script>
	<script src="http://chat.dangsam.com:8003/socket.io/socket.io.js"></script>
	<script src="jquery.cookie.js"></script>
<script type="text/javascript">
	function _view() {
		var lastMessage;
		
		// type msg {nickname, message}
		this.echoMessage = function(msg) {
			msg.time = new Date();
			var list = $('#chatList');
			if (lastMessage && 
				(lastMessage.nickname === msg.nickname && msg.time - lastMessage.time < 10000)) {
				// append to last message
				$('#chatList li').last().append($('<p>').css({'overflow': 'visible', 'white-space': 'normal'}).text(msg.message));
			} else {
				// add new message
				var newItem = $('<li>')
					.append($('<h4>').text(msg.nickname))
					.append($('<p>').addClass('ui-li-aside').text(msg.time.toLocaleTimeString()))
					.append($('<p>').css({'overflow': 'visible', 'white-space': 'normal'}).text(msg.message));
				list.append(newItem);
			}
			lastMessage = msg;
			list.listview('refresh');
			
			var chatContainer = $('#chatContainer');
			if ($('body').height() < chatContainer.height()) {
				chatContainer.css('position', 'relative');
				$('body').animate({scrollTop: $('#page1').height()}, 0);
			} else {
				chatContainer.css('position', 'fixed');
			}
		}
		
		// string msg
		this.echoSystemMessage = function(msg) {
			lastMessage = undefined;
			var list = $('#chatList');
			var newItem = $('<li>', {'data-role': 'list-divider'}).text(msg);
			list.append(newItem);
			$('#ad').appendTo('#chatList');
			list.listview('refresh');

			var chatContainer = $('#chatContainer');
			if ($('body').height() < chatContainer.height()) {
				chatContainer.css('position', 'relative');
				$('body').animate({scrollTop: $('#page1').height()}, 0);
			} else {
				chatContainer.css('position', 'fixed');
			}
		}
		
		this.setFocusToInput = function() {
			$('#message').focus().select();
		}
		
		this.openLoginPopup = function() {
			$('#popupLogin').popup('open');
		}
		
		this.closeLoginPopup = function() {
			$('#popupLogin').popup('close');
		}
		
		this.setUsername = function(username) {
			$('#username').val(username);
		}

		this.getUsername = function() {
			return $('#username').val();
		}
		
		var handlers = {
			'send message': function() {},
			'change nickname': function() {}
		};
		
		this.on = function(event, handler) {
			if (handlers[event]) {
				handlers[event] = handler;
			};
		}
		
		this.emit = function(event) {
			if (handlers[event]) {
				var arg = Array.prototype.slice.call(arguments, 1);
				return handlers[event].apply(this, arg);
			} else {
				throw '"' + event + '" has not been bound';
			}
		}
	}
	view = new _view();

</script>
	<script src="main.js"></script>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-4906577-7']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

</head>
<body>
	<div data-role="page" id="page1" style="">
		<div data-role="panel" id="menuPanel" data-position="right">
			<ul data-role="listview" id="userList">
				<li data-role="list-divider">Users</li>
				<li>lisyoen</li>
				<li>lisyoen</li>
				<li>lisyoen</li>
				<li><a href="#popupLogin" data-rel="popup">
				Change Nickname
				</a></li>
			</ul>
		</div>
		<div data-role="content" id="Content1" style="padding: 0px;">
			<div id="chatContainer" style="position:fixed; bottom:0px; width:100%;">
				<ul data-role="listview" id="chatList" style="margin: 0px;" data-theme="c">
<div id="ad">
<script type="text/javascript"><!--
google_ad_client = "ca-pub-5187271410488826";
/* 468x60, 작성됨 11. 1. 12 Jobs 상하단용 */
google_ad_slot = "9658017922";
google_ad_width = 468;
google_ad_height = 60;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</div>
				</ul>
				<!--
				<a href="#popupLogin" style="position:fixed; right:0px; bottom:36px;" data-role="button" 
					data-rel="popup" data-icon="refresh" data-iconpos="notext" 
					data-inline="true" data-position-to="window">Change Nickname</a>
				-->
				<div style="width:100%; text-align:right; margin-top:-40px;">
				<a href="#menuPanel" style="position:relative; right:0px;" data-role="button" 
					data-icon="bars" data-iconpos="notext" 
					data-inline="true" data-position-to="window">Change Nickname</a>
				</div>
				<input type="text" id="message" name="message" data-mini="true" data-clear-btn="true" tabindex="0" 
					placeholder="Enter your message" onkeydown="javascript:{if (event.keyCode == 13) {view.emit('send message', message.value); message.value='';}}" data-theme="c">
			</div>
			<div data-role="popup" id="popupLogin" class="ui-corner-all" data-theme="a">
				<div style="padding:10px 20px;">
					<h3>Please sign in</h3>
					<input type="text" name="user" id="username" value="" placeholder="username" data-theme="a">
					<button data-theme="b" data-icon="check" onclick="javascript:view.emit('change nickname', username.value)">Sign in</button>
				</div>
			</div>
		</div>
	</div>
</body>
</html>
